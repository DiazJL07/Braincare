<link rel="stylesheet" href="/css/dashboard-general.css">

<div class="gen-dash-wrapper animate-fade-in">
  <div class="gen-header-row">
    <div>
      <h1 class="gen-page-title"><%= article._id ? 'Editar Artículo' : 'Crear Artículo' %></h1>
      <p class="gen-page-subtitle">Gestiona el contenido, tema e imagen del artículo</p>
    </div>
    <div class="gen-header-actions">
      <a href="/articles/admin/dashboard" class="gen-btn gen-btn-outline"><i class="fas fa-arrow-left"></i> Volver al dashboard</a>
    </div>
  </div>

  <% let errorMsg = null; if (typeof error !== 'undefined') { if (Array.isArray(error)) { if (error.length > 0) { errorMsg = error[0]; } } else if (typeof error === 'string' && error.trim().length > 0) { errorMsg = error; } } %>
  <% if (errorMsg) { %>
    <div class="gen-panel" style="border-left:4px solid var(--gen-danger);">
      <div class="alert alert-danger"><%= errorMsg %></div>
    </div>
  <% } %>

  <div class="gen-panel">
    <form action="<%= article._id ? `/articles/admin/${article._id}` : '/articles/admin' %>" method="POST" enctype="multipart/form-data">
      <div class="gen-filter-grid" style="grid-template-columns: 1fr;">
        <div class="gen-form-group">
          <label class="gen-label">Título</label>
          <input type="text" class="gen-input" id="title" name="title" value="<%= article.title || '' %>" required>
        </div>

        <div class="gen-form-group">
          <label class="gen-label">Tema</label>
          <select class="gen-select" id="topic" name="topic" required>
            <option value="" disabled <%= !article.topic ? 'selected' : '' %>>Selecciona un tema</option>
            <option value="Transtornos" <%= article.topic === 'Transtornos' ? 'selected' : '' %>>Transtornos</option>
            <option value="Recomendaciones" <%= article.topic === 'Recomendaciones' ? 'selected' : '' %>>Recomendaciones</option>
            <option value="Tratamientos" <%= article.topic === 'Tratamientos' ? 'selected' : '' %>>Tratamientos</option>
            <option value="Prevencion" <%= article.topic === 'Prevencion' ? 'selected' : '' %>>Prevención</option>
            <option value="Investigacion" <%= article.topic === 'Investigacion' ? 'selected' : '' %>>Investigación</option>
          </select>
        </div>

        <div class="gen-form-group">
          <label class="gen-label">Contenido</label>
          <textarea class="gen-input gen-textarea" id="content" name="content" required><%= article.content || '' %></textarea>
          <div id="editor-status" class="mt-2"></div>
          <small style="color: var(--gen-text-secondary);">Puedes usar HTML para dar formato al contenido.</small>
        </div>

        <div class="gen-form-group">
          <label class="gen-label">Imagen</label>
          <div class="gen-file-upload">
            <input type="file" class="gen-file-input" id="image" name="image" accept="image/*">
            <div id="imgUploadText"><span>Seleccionar Imagen</span></div>
          </div>
          <% if (article.image) { %>
            <div style="margin-top:12px; display:flex; align-items:center; gap:12px;">
              <img src="<%= article.image %>" alt="Imagen actual" class="gen-thumbnail" style="width:80px; height:80px; object-fit:cover;">
              <small style="color: var(--gen-text-secondary);">Sube una nueva imagen para reemplazar la actual.</small>
            </div>
          <% } %>
        </div>
      </div>

      <div class="gen-panel" style="display:flex; justify-content:flex-end; gap:10px;">
        <a href="/articles/admin/dashboard" class="gen-btn gen-btn-outline">Cancelar</a>
        <button type="submit" class="gen-btn gen-btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Incluir un editor WYSIWYG para el contenido -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/5.10.5/tinymce.min.js" integrity="sha512-TXT0EzcpK/3HKqUw8HkXUDKnZQf+MvUF7FEJdV4jqGgHJKXwvjFlnJcEJk0UZYNXQntgGgVmgvZJjXqfOcysxg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const editorStatusEl = document.getElementById('editor-status');
    const contentTextarea = document.getElementById('content');
    const form = document.querySelector('form');
    
    // Mostrar mensaje de carga
    editorStatusEl.innerHTML = '<div class="alert alert-info">Cargando editor...</div>';
    
    try {
      tinymce.init({
        selector: '#content',
        height: 400,
        plugins: [
          'advlist autolink lists link image charmap print preview anchor',
          'searchreplace visualblocks code fullscreen',
          'insertdatetime media table paste code help wordcount'
        ],
        toolbar: 'undo redo | formatselect | bold italic backcolor | \
          alignleft aligncenter alignright alignjustify | \
          bullist numlist outdent indent | removeformat | help',
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 16px; }',
        setup: function(editor) {
          editor.on('init', function() {
            editorStatusEl.innerHTML = '<div class="alert alert-success">Editor cargado correctamente</div>';
            // Ocultar el mensaje después de 3 segundos
            setTimeout(function() {
              editorStatusEl.innerHTML = '';
            }, 3000);
          });
          
          editor.on('change', function() {
            editor.save(); // Guarda el contenido en el textarea original
          });
        }
      });
      
      // Asegurarse de que el formulario envíe el contenido del editor
      form.addEventListener('submit', function(e) {
        // Verificar si el editor está inicializado
        if (tinymce.activeEditor) {
          tinymce.activeEditor.save();
          
          // Verificar si hay contenido
          if (!contentTextarea.value.trim()) {
            e.preventDefault();
            editorStatusEl.innerHTML = '<div class="alert alert-danger">Por favor, ingresa contenido para el artículo</div>';
            return false;
          }
        } else {
          // Si el editor no está inicializado, verificar el textarea directamente
          if (!contentTextarea.value.trim()) {
            e.preventDefault();
            editorStatusEl.innerHTML = '<div class="alert alert-danger">Por favor, ingresa contenido para el artículo</div>';
            return false;
          }
        }
      });
    } catch (error) {
      // Si hay un error al inicializar TinyMCE, mostrar un mensaje y habilitar el textarea normal
      console.error('Error al inicializar TinyMCE:', error);
      editorStatusEl.innerHTML = '<div class="alert alert-warning">No se pudo cargar el editor avanzado. Puedes usar el editor básico.</div>';
      contentTextarea.style.display = 'block';
    }
  });
</script>

  <!-- Tu JS primero, para que el callback global exista antes de cargar el script de Google -->
  <script src="/js/tradux.js"></script>
  <!-- Script oficial de Google (callback definido en translate.js) -->
  <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<%- include('../partials/footer') %>
<% if (errorMsg) { %>
<div class="modal" id="articleErrorModal" style="display:block; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1050;">
  <div class="modal-dialog" style="margin:10% auto; max-width:500px;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Error al subir imagen</h5>
        <button type="button" class="btn-close" onclick="document.getElementById('articleErrorModal').style.display='none'"></button>
      </div>
      <div class="modal-body">
        <p><%= errorMsg %></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('articleErrorModal').style.display='none'">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<% } %>
