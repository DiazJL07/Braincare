<%- include('../partials/header') %>
<link rel="stylesheet" href="/css/admin-forms.css">

<div class="container mt-4">
  <h1 class="mb-4"><%= guide._id ? 'Editar' : 'Nueva' %> Guía</h1>
  
  <% if (locals.error) { %>
    <div class="alert alert-danger">
      <%= error %>
    </div>
  <% } %>
  
  <div class="card">
    <div class="card-body">
      <form action="<%= guide._id ? `/guides/admin/${guide._id}` : '/guides/admin' %>" method="POST" enctype="multipart/form-data">
        <div class="row">
          <!-- Columna izquierda: Información básica -->
          <div class="col-md-6">
            <div class="mb-3">
              <label for="title" class="form-label">Título</label>
              <input type="text" class="form-control" id="title" name="title" value="<%= guide.title || '' %>" required>
            </div>
            
            <div class="mb-3">
              <label for="topic" class="form-label">Tema</label>
              <select class="form-select" id="topic" name="topic" required>
                <option value="" disabled <%= !guide.topic ? 'selected' : '' %>>Selecciona un tema</option>
                <option value="Transtornos" <%= guide.topic === 'Transtornos' ? 'selected' : '' %>>Transtornos</option>
                <option value="Recomendaciones" <%= guide.topic === 'Recomendaciones' ? 'selected' : '' %>>Recomendaciones</option>
                <option value="Tratamientos" <%= guide.topic === 'Tratamientos' ? 'selected' : '' %>>Tratamientos</option>
                <option value="Prevencion" <%= guide.topic === 'Prevencion' ? 'selected' : '' %>>Prevención</option>
                <option value="Investigacion" <%= guide.topic === 'Investigacion' ? 'selected' : '' %>>Investigación</option>
              </select>
            </div>
          </div>
          
          <!-- Columna derecha: Archivos -->
          <div class="col-md-6">
            <div class="mb-3">
              <label for="image" class="form-label">Imagen de portada (opcional)</label>
              <input type="file" class="form-control" id="image" name="image" accept="image/*">
              <small class="form-text text-muted">Tamaño máximo: 5MB. Formatos: JPG, PNG, GIF</small>
              
              <% if (guide.image) { %>
                <div class="mt-2">
                  <p>Imagen actual:</p>
                  <img src="<%= guide.image %>" alt="Imagen actual" class="img-thumbnail" style="max-height: 150px;">
                  <small class="d-block text-muted">Sube una nueva imagen para reemplazar la actual</small>
                </div>
              <% } %>
            </div>
            
            <div class="mb-3">
              <label for="pdfFile" class="form-label">Archivo PDF <%= !guide.pdfFile ? '(requerido)' : '(opcional)' %></label>
              <input type="file" class="form-control" id="pdfFile" name="pdfFile" accept="application/pdf" <%= !guide.pdfFile ? 'required' : '' %>>
              <small class="form-text text-muted">Tamaño máximo: 10MB. Solo archivos PDF.</small>
              
              <% if (guide.pdfFile) { %>
                <div class="mt-2">
                  <p>PDF actual: <a href="<%= guide.pdfFile %>" target="_blank"><%= guide.title %>.pdf</a></p>
                  <small class="d-block text-muted">Sube un nuevo PDF para reemplazar el actual</small>
                </div>
              <% } %>
            </div>
          </div>
        </div>
        
        <div class="d-flex justify-content-between mt-4">
          <a href="/guides/admin/dashboard" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

  <!-- Tu JS primero, para que el callback global exista antes de cargar el script de Google -->
  <script src="/js/tradux.js"></script>
  <!-- Script oficial de Google (callback definido en translate.js) -->
  <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<%- include('../partials/footer') %>
<% if (typeof error !== 'undefined' && error) { %>
<div class="modal" id="guideErrorModal" style="display:block; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1050;">
  <div class="modal-dialog" style="margin:10% auto; max-width:500px;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Error al subir archivo</h5>
        <button type="button" class="btn-close" onclick="document.getElementById('guideErrorModal').style.display='none'"></button>
      </div>
      <div class="modal-body">
        <p><%= error %></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('guideErrorModal').style.display='none'">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<% } %>