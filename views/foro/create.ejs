<%- include('../partials/header', { title: 'Crear nueva publicación en el foro' }) %>

<div class="row mb-4">
  <div class="col-md-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/foro">Foro</a></li>
        <li class="breadcrumb-item active" aria-current="page">Crear publicación</li>
      </ol>
    </nav>
  </div>
</div>

<div class="row">
  <div class="col-lg-8 mx-auto">
    <div class="card shadow">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">Crear nueva publicación</h4>
      </div>
      <div class="card-body">
        <% if (typeof error !== 'undefined') { %>
          <div class="alert alert-danger">
            <%= error %>
          </div>
        <% } %>
        
        <% if(success_msg && success_msg.length > 0) { %>
          <div class="alert alert-success">
            <%= success_msg %>
          </div>
        <% } %>
        
        <% if(error_msg && error_msg.length > 0) { %>
          <div class="alert alert-danger">
            <%= error_msg %>
          </div>
        <% } %>
        
        <form action="/foro" method="POST" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="title" class="form-label">Título</label>
            <input type="text" class="form-control" id="title" name="title" value="<%= foro.title || '' %>" required>
          </div>
          
          <div class="mb-3">
            <label for="topic" class="form-label">Tema</label>
            <select class="form-select" id="topic" name="topic" required>
              <option value="" disabled <%= !foro.topic ? 'selected' : '' %>>Selecciona un tema</option>
              <% topics.forEach(topic => { %>
                <option value="<%= topic._id %>" <%= foro.topic === topic._id ? 'selected' : '' %>><%= topic.name %></option>
              <% }); %>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="content" class="form-label">Contenido</label>
            <textarea class="form-control" id="content" name="content" rows="10" required><%= foro.content || '' %></textarea>
            <div id="editor-status" class="mt-2"></div>
            <small class="form-text text-muted">Puedes usar el editor para dar formato al contenido.</small>
          </div>
          
          <div class="mb-3">
            <label for="image" class="form-label">Imagen (opcional)</label>
            <input type="file" class="form-control" id="image" name="image" accept="image/*">
            <div class="form-text">Tamaño máximo: 5MB. Formatos permitidos: JPG, PNG, GIF.</div>
          </div>
          
          <div class="d-flex justify-content-between">
            <a href="/foro" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">Publicar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/5.10.5/tinymce.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const editorStatus = document.getElementById('editor-status');
    const contentField = document.getElementById('content');
    editorStatus.innerHTML = '<div class="alert alert-info">Cargando editor...</div>';

    try {
      tinymce.init({
        selector: '#content',
        height: 400,
        plugins: 'advlist autolink lists link image charmap print preview anchor searchreplace visualblocks code fullscreen insertdatetime media table paste code help wordcount',
        toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
        content_style: 'body { font-family: Arial, sans-serif; font-size: 16px; }',
        setup: editor => {
          editor.on('init', () => {
            editorStatus.innerHTML = '<div class="alert alert-success">Editor cargado correctamente</div>';
            setTimeout(() => editorStatus.innerHTML = '', 3000);
          });
          editor.on('change', () => editor.save());
        }
      });

      // El manejo del envío del formulario se realiza en comments.js
    } catch (error) {
      editorStatus.innerHTML = '<div class="alert alert-warning">No se pudo cargar el editor. Usa el campo básico.</div>';
      contentField.style.display = 'block';
    }
  });
</script>

<!-- Incluir JavaScript para manejo de errores de baneo -->
<script src="/js/comments.js"></script>
  <!-- Tu JS primero, para que el callback global exista antes de cargar el script de Google -->
  <script src="/js/tradux.js"></script>
  <!-- Script oficial de Google (callback definido en translate.js) -->
  <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<%- include('../partials/footer') %>